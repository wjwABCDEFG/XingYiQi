# 协议格式

## 基本格式

全部socket tcp请求和响应都必须遵循以下格式的**json字符串**，表明“谁，想干啥，怎么干”，这一层不包括游戏逻辑，游戏逻辑体现在data中

```json
{
    "types": 0,
    "sender": "",
    "data": {}
}
```

*新版本发送tcp请求时sender可以不填，但服务器发回来的数据仍然会带有sender*

具体如下表

| key    | value                                    | 类型        | 说明                                                         |
| ------ | ---------------------------------------- | ----------- | ------------------------------------------------------------ |
| sender | {ip}:{port}                              | string      | 标记“谁”发送本次请求                                         |
| types  | 0/1/2                                    | int         | 0: socket请求（tcp），1: http请求，2: rpc请求，后续服务器可能还要兼容其他网络协议（websocket） |
| data   | {"method": "login", "user": "wenjiawei"} | json object | 游戏逻辑，看下面的接口文档                                   |

python示例

```python
class Msg:
    TYPE_OFFLINE = -1
    TYPE_LOGIN = 0
    TYPE_NORMAL = 1     # 发送给服务器
    TYPE_CHAT = 2       # 发送给用户，例如广播，群聊，私聊
    TYPE_RPC = 3        # rpc类消息

    def __init__(self, data, types=1, sender=''):
        self.data = data
        self.types = types
        self.sender = sender

    def __str__(self):
        return self.value

    @property
    def value(self):
        return json.dumps({'types': self.types,
                           'data': self.data,
                           'sender': self.sender})

    @property
    def body(self):
        return {'types': self.types,
                'data': self.data,
                'sender': self.sender}

    @staticmethod
    def load(val: string) -> 'Msg':
        try:
            info = json.loads(val)
            return Msg(info['data'], info['types'], info['sender'])
        except Exception as e:
            traceback.print_exc()
```

## TCP示例

用于网络游戏消息，聊天等广播/双工通信

基本格式是

```python
# socket = Socket连接对象
# ...
data = {
    "method": "login",
    "user_name": "wenjiawei",
    "password": "123456"
}
socket.send(Msg(data).value)
```

## RPC示例

用于登录等单工通信，提供一种简单的调用方式

```python
# socket = Socket连接对象
# ...


# rpc_client伪代码，若没有实现可以直接拷贝xyq_server/client_sample/rpc_client
class RPCClient(object):
    def __getattr__(self, item):
        def func(*args, **kwargs):
            stub = {
                'func_name': item,
                'func_args': args,
                'func_kwargs': kwargs
            }
            socket.send(json.dumps({
                "types": 3,
                "data": stub
            }))

        setattr(self, item, func)
        return func


# rpc示例
rpc_client.login(user_name="wenjiawei", password="123456")		# 比tcp版本简单很多
```

## HTTP示例

服务器支持http，就正常的requests请求即可

```python
requests.post('http://127.0.0.1:9394/login', json={"user_name": "wenjiawei", "password": "123456"})
```

## WebSocket示例

暂未支持



现在你已经掌握了基本的几种通信方式，下面来看接口文档吧，不同的接口会标注使用哪种方式，不要用错噢



# 接口API

## ~~登录游戏~~

### 请求方式

[HTTP POST] `/login`

### 参数

| key      | 类型 | 必填 | desc |
| -------- | ---- | ---- | ---- |
| username | str  | √   |      |
| password | str  | √   |      |

## 开始匹配

### 请求方式

`SOCKET TCP`

### 参数

Msg.types=TYPE_NORMAL

Msg.data: 

| key    | 类型   | value         | 必填 | d                |
| ------ | ------ | ------------- | ---- | ------------------- |
| method | str    | match         | √    | 开始游戏                              |
| params | object | {open_id: id} | √    | 玩家的小程序open_id，没有可以暂时置空 |

### 示例

```python
# socket = Socket连接对象
# ...
data = {
    "method": "match",
    "params": {"open_id": 123}
}
socket.send(Msg(data, TYPE_NORMAL).value)
```

### 返回值

无返回值，但是服务端在匹配成功后会发送给两个玩家一个game_id

```json
{
    "code": 200,
    "msg": "",
    "data": {
        "state": 2,						// IDLE:0  WAITING:1  PLAYING:2
        "game_id": 1414635113056,
        "player_id": 1414675644080,
        "power": true					// 当前玩家是否可以移动棋子
    }
}
```



## 开始游戏

按照1212发牌,每人2张

### 请求方式

`SOCKET TCP / RPC`

### 参数

Msg.types=TYPE_RPC / TYPE_NORMAL

Msg.data: 

| key    | 类型   | value            | 必填 | desc     |
| ------ | ------ | ---------------- | ---- | -------- |
| method | str    | begin            | √   | 开始游戏 |
| params | object | {"player_id": xxx} | √   | 房间id   |

### 示例

```python
# RPC方式
rpc_client.begin(player_id=123, callback='fn_1')


# tcp方式
data = {
    "method": "begin",
    "params": {"player_id": 123}
}
socket.send(Msg(data, TYPE_NORMAL).value)
```

### 返回值

返回棋盘的json数据

```json
{
    "code": 200,
    "msg": "",
    "data": {
        "id": 1414635113056,
        "game_id": 1414635113056,
        "pan": {
            "id": 1414635113104,
            "chess": [
                {
                    "id": 1414675643984,
                    "pos": [
                        0,
                        2
                    ],
                    "camp": false,
                    "role": 0
                },
                {
                    "id": 1414675643888,
                    "pos": [
                        0,
                        0
                    ],
                    "camp": false,
                    "role": 1
                },
                {
                    "id": 1414675643936,
                    "pos": [
                        0,
                        1
                    ],
                    "camp": false,
                    "role": 1
                },
                {
                    "id": 1414675643456,
                    "pos": [
                        0,
                        3
                    ],
                    "camp": false,
                    "role": 1
                },
                {
                    "id": 1414675643840,
                    "pos": [
                        0,
                        4
                    ],
                    "camp": false,
                    "role": 1
                },
                {
                    "id": 1414675644176,
                    "pos": [
                        4,
                        2
                    ],
                    "camp": true,
                    "role": 0
                },
                {
                    "id": 1414675644224,
                    "pos": [
                        4,
                        0
                    ],
                    "camp": true,
                    "role": 1
                },
                {
                    "id": 1414675644272,
                    "pos": [
                        4,
                        1
                    ],
                    "camp": true,
                    "role": 1
                },
                {
                    "id": 1414675644320,
                    "pos": [
                        4,
                        3
                    ],
                    "camp": true,
                    "role": 1
                },
                {
                    "id": 1414675644368,
                    "pos": [
                        4,
                        4
                    ],
                    "camp": true,
                    "role": 1
                }
            ]
        },
        "pai": [
            "card5",
            "card3"
        ]
    },
    "callback": "update_view"
}
```

## ~~猜先~~

发送：出的拳

返回：两个人出的拳的结果

power：False

### 参数

data中的参数

| key    | 类型   | value             | 必填 | desc            |
| ------ | ------ | ----------------- | ---- | --------------- |
| to     | str    | 'game_id'         | √   | tcp             |
| method | str    | move              | √   | 移动棋子        |
| params | object | {"quan": 0\|1\|2} | √   | 0剪刀 1石头 2布 |

### 示例

```python
{
	"game_id": 123,
	"quan": 0
}
```

### 返回值

```json
{
    "code": 200,
    "msg": "",
    "data": {
        "player_1": 0,
    	"player_2": 1
    }
}
```

如果一样，客户端重新发送请求

## 移动棋子

### 请求方式

`SOCKET TCP / RPC`

### 参数

Msg.types=TYPE_RPC / TYPE_NORMAL

Msg.data: 

| key    | 类型   | value            | 必填 | desc     |
| ------ | ------ | ---------------- | ---- | -------- |
| method | str    | move             | √   | 移动棋子 |
| params | object | {<br/>	"game_id": 123,<br/>	"player_id": 123,<br/>	"pai_id": 123,<br/>	"chess_id": 123,<br/>	"from_pos": [0, 0],<br/>	"to_pos": [1, 1]<br/>} | √   |    |

```python
# RPC示例
rpc_client.move(game_id=123, player_id=123, chess_id=123, pai_id=123, from_pos=[0, 0], to_pos=[1, 1])

# tcp示例
self.send(Msg({'method': 'move',
               'params': {
                   'player_id': 123,
                   'chess_id': 123,
                   'pai_id': 123,
                   'from_pos': [0, 0],
                   'to_pos': [1, 1]
               }},
              types=Msg.TYPE_NORMAL).value)
```

